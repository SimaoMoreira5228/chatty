name: release

on:
  push:
    branches: [main]
    paths:
      - Cargo.toml
      - crates/chatty_server/Cargo.toml
      - crates/chatty_client_gui/Cargo.toml

permissions:
  contents: write

jobs:
  detect_release:
    runs-on: ubuntu-latest
    outputs:
      release_needed: ${{ steps.detect.outputs.release_needed }}
      version: ${{ steps.detect.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: detect
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          CURRENT_VERSION=$(python -c "import tomllib, pathlib; data = tomllib.loads(pathlib.Path('Cargo.toml').read_text()); print(data['workspace']['package']['version'])")
          PREV_VERSION=$(git show "$BEFORE:Cargo.toml" | python -c "import tomllib, sys; data = tomllib.loads(sys.stdin.read()); print(data['workspace']['package']['version'])")

          if [ "$CURRENT_VERSION" != "$PREV_VERSION" ]; then
            echo "release_needed=true" >> "$GITHUB_OUTPUT"
          else
            echo "release_needed=false" >> "$GITHUB_OUTPUT"
          fi

          echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

  create_release:
    runs-on: ubuntu-latest
    needs: detect_release
    if: needs.detect_release.outputs.release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.detect_release.outputs.version }}
          name: v${{ needs.detect_release.outputs.version }}
          generate_release_notes: true

  build_server_linux:
    runs-on: ubuntu-latest
    needs: [create_release, detect_release]
    if: needs.detect_release.outputs.release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build server (linux)
        run: cargo build -p chatty_server --release
      - name: Package server artifact
        run: tar -czf chatty_server-linux-x86_64.tar.gz -C target/release chatty_server
      - name: Upload server artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.detect_release.outputs.version }}
          files: chatty_server-linux-x86_64.tar.gz

  build_client_linux:
    runs-on: ubuntu-latest
    needs: [create_release, detect_release]
    if: needs.detect_release.outputs.release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            libx11-dev \
            libxkbcommon-dev \
            libxcb1-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxrandr-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libasound2-dev
      - name: Build client (linux)
        run: cargo build -p chatty_client_gui --release --features gpui
      - name: Prepare linux package
        run: |
          set -euo pipefail
          rm -rf dist/linux
          mkdir -p dist/linux
          cp target/release/chatty dist/linux/
          cp crates/chatty_client_gui/packaging/linux/chatty.desktop dist/linux/
          cp crates/chatty_client_gui/packaging/linux/README.md dist/linux/
          if [ -f crates/chatty_client_gui/assets/app-icons/chatty.png ]; then
            cp crates/chatty_client_gui/assets/app-icons/chatty.png dist/linux/
          fi
      - name: Package client artifact
        run: tar -czf chatty-linux-x86_64.tar.gz -C dist/linux .
      - name: Upload client artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.detect_release.outputs.version }}
          files: chatty-linux-x86_64.tar.gz

  build_client_windows:
    runs-on: windows-latest
    needs: [create_release, detect_release]
    if: needs.detect_release.outputs.release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build client (windows)
        run: cargo build -p chatty_client_gui --release --features gpui
      - name: Package client artifact
        shell: pwsh
        run: |
          Compress-Archive -Path target/release/chatty.exe -DestinationPath chatty-windows-x86_64.zip
      - name: Upload client artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.detect_release.outputs.version }}
          files: chatty-windows-x86_64.zip

  build_client_macos:
    runs-on: macos-latest
    needs: [create_release, detect_release]
    if: needs.detect_release.outputs.release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build client (macos)
        run: cargo build -p chatty_client_gui --release --features gpui
      - name: Bundle app if icon exists
        id: bundle
        run: |
          set -euo pipefail
          ICON_PATH="crates/chatty_client_gui/assets/app-icons/chatty.icns"
          if [ -f "$ICON_PATH" ]; then
            cargo install cargo-bundle --locked
            cargo bundle -p chatty_client_gui --release --features gpui
            APP_PATH="target/release/bundle/osx/Chatty.app"
            ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" chatty-macos-app.zip
            echo "artifact=chatty-macos-app.zip" >> "$GITHUB_OUTPUT"
          else
            tar -czf chatty-macos-x86_64.tar.gz -C target/release chatty
            echo "artifact=chatty-macos-x86_64.tar.gz" >> "$GITHUB_OUTPUT"
          fi
      - name: Upload client artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.detect_release.outputs.version }}
          files: ${{ steps.bundle.outputs.artifact }}
