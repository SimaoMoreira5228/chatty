name: release

on:
  push:
    branches: [main]
    paths:
      - crates/chatty_client_gui/Cargo.toml
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  detect_release:
    runs-on: ubuntu-latest
    outputs:
      server_release_needed: ${{ steps.detect.outputs.server_release_needed }}
      client_release_needed: ${{ steps.detect.outputs.client_release_needed }}
      server_version: ${{ steps.detect.outputs.server_version }}
      client_version: ${{ steps.detect.outputs.client_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect release
        id: detect
        env:
          BEFORE_SHA: ${{ github.event.before }}
        run: python .github/workflows/scripts/detect_release.py

  build_client_linux:
    runs-on: ubuntu-22.04
    needs: detect_release
    if: needs.detect_release.outputs.client_release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            protobuf-compiler \
            libssl-dev \
            libx11-dev \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxrandr-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libvulkan-dev \
            libwayland-dev \
            libasound2-dev \
            libdbus-1-dev
      - name: Build client (linux)
        env:
          CHATTY_SERVER_ENDPOINT: ${{ secrets.CHATTY_SERVER_ENDPOINT }}
          CHATTY_HMAC_ENABLED: false
          CHATTY_TWITCH_LOGIN_URL: ${{ secrets.CHATTY_TWITCH_LOGIN_URL }}
          CHATTY_KICK_LOGIN_URL: ${{ secrets.CHATTY_KICK_LOGIN_URL }}
        run: cargo build -p chatty_client_gui --release --features mimalloc
      - name: Prepare linux package
        run: |
          set -euo pipefail
          rm -rf dist/linux
          mkdir -p dist/linux
          cp target/release/chatty dist/linux/
          cp crates/chatty_client_gui/packaging/linux/chatty.desktop dist/linux/
          cp crates/chatty_client_gui/packaging/linux/README.md dist/linux/
          if [ -f crates/chatty_client_gui/assets/app-icons/chatty.png ]; then
            cp crates/chatty_client_gui/assets/app-icons/chatty.png dist/linux/
          fi
      - name: Package client artifact
        run: tar -czf chatty-linux-x86_64.tar.gz -C dist/linux .
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-linux
          path: chatty-linux-x86_64.tar.gz

  build_client_linux_arm:
    runs-on: ubuntu-22.04-arm
    needs: detect_release
    if: needs.detect_release.outputs.client_release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            protobuf-compiler \
            libssl-dev \
            libx11-dev \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxrandr-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libvulkan-dev \
            libwayland-dev \
            libasound2-dev \
            libdbus-1-dev
      - name: Build client (linux/arm)
        env:
          CHATTY_SERVER_ENDPOINT: ${{ secrets.CHATTY_SERVER_ENDPOINT }}
          CHATTY_HMAC_ENABLED: false
          CHATTY_TWITCH_LOGIN_URL: ${{ secrets.CHATTY_TWITCH_LOGIN_URL }}
          CHATTY_KICK_LOGIN_URL: ${{ secrets.CHATTY_KICK_LOGIN_URL }}
        run: cargo build -p chatty_client_gui --release --features mimalloc
      - name: Prepare linux package (arm)
        run: |
          set -euo pipefail
          rm -rf dist/linux
          mkdir -p dist/linux
          cp target/release/chatty dist/linux/
          cp crates/chatty_client_gui/packaging/linux/chatty.desktop dist/linux/
          cp crates/chatty_client_gui/packaging/linux/README.md dist/linux/
          if [ -f crates/chatty_client_gui/assets/app-icons/chatty.png ]; then
            cp crates/chatty_client_gui/assets/app-icons/chatty.png dist/linux/
          fi
      - name: Package client artifact (arm)
        run: tar -czf chatty-linux-arm64.tar.gz -C dist/linux .
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-linux-arm64
          path: chatty-linux-arm64.tar.gz

  build_client_windows:
    runs-on: windows-2022
    needs: detect_release
    if: needs.detect_release.outputs.client_release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install protobuf-compiler
        run: choco install protoc
      - name: Build client (windows)
        env:
          CHATTY_SERVER_ENDPOINT: ${{ secrets.CHATTY_SERVER_ENDPOINT }}
          CHATTY_HMAC_ENABLED: false
          CHATTY_TWITCH_LOGIN_URL: ${{ secrets.CHATTY_TWITCH_LOGIN_URL }}
          CHATTY_KICK_LOGIN_URL: ${{ secrets.CHATTY_KICK_LOGIN_URL }}
        run: cargo build -p chatty_client_gui --release --features mimalloc
      - name: Package client artifact
        shell: pwsh
        run: |
          Compress-Archive -Path target/release/chatty.exe -DestinationPath chatty-windows-x86_64.zip
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-windows
          path: chatty-windows-x86_64.zip

  build_client_macos_intel:
    runs-on: macos-15-intel
    needs: detect_release
    if: needs.detect_release.outputs.client_release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install protobuf-compiler
        run: brew install protobuf
      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main
      - name: Bundle app if icon exists
        env:
          CHATTY_SERVER_ENDPOINT: ${{ secrets.CHATTY_SERVER_ENDPOINT }}
          CHATTY_HMAC_ENABLED: false
          CHATTY_TWITCH_LOGIN_URL: ${{ secrets.CHATTY_TWITCH_LOGIN_URL }}
          CHATTY_KICK_LOGIN_URL: ${{ secrets.CHATTY_KICK_LOGIN_URL }}
        id: bundle
        run: |
          set -euo pipefail
          ICON_PATH="crates/chatty_client_gui/assets/app-icons/chatty.icns"
          if [ -f "$ICON_PATH" ]; then
            cargo binstall cargo-bundle --no-confirm
            cargo bundle -p chatty_client_gui --release --features mimalloc
            APP_PATH="target/release/bundle/osx/Chatty.app"
            ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" chatty-macos-intel-app.zip
            echo "artifact=chatty-macos-intel-app.zip" >> "$GITHUB_OUTPUT"
          else
            cargo build -p chatty_client_gui --release --features mimalloc
            tar -czf chatty-macos-x86_64-intel.tar.gz -C target/release chatty
            echo "artifact=chatty-macos-x86_64-intel.tar.gz" >> "$GITHUB_OUTPUT"
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-macos-intel
          path: ${{ steps.bundle.outputs.artifact }}

  build_client_macos_arm:
    runs-on: macos-14
    needs: detect_release
    if: needs.detect_release.outputs.client_release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install protobuf-compiler
        run: brew install protobuf
      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main
      - name: Bundle app if icon exists
        env:
          CHATTY_SERVER_ENDPOINT: ${{ secrets.CHATTY_SERVER_ENDPOINT }}
          CHATTY_HMAC_ENABLED: false
          CHATTY_TWITCH_LOGIN_URL: ${{ secrets.CHATTY_TWITCH_LOGIN_URL }}
          CHATTY_KICK_LOGIN_URL: ${{ secrets.CHATTY_KICK_LOGIN_URL }}
        id: bundle
        run: |
          set -euo pipefail
          ICON_PATH="crates/chatty_client_gui/assets/app-icons/chatty.icns"
          if [ -f "$ICON_PATH" ]; then
            cargo binstall cargo-bundle --no-confirm
            cargo bundle -p chatty_client_gui --release --features mimalloc
            APP_PATH="target/release/bundle/osx/Chatty.app"
            ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" chatty-macos-arm-app.zip
            echo "artifact=chatty-macos-arm-app.zip" >> "$GITHUB_OUTPUT"
          else
            cargo build -p chatty_client_gui --release --features mimalloc
            tar -czf chatty-macos-arm64.tar.gz -C target/release chatty
            echo "artifact=chatty-macos-arm64.tar.gz" >> "$GITHUB_OUTPUT"
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-macos-arm
          path: ${{ steps.bundle.outputs.artifact }}

  create_client_release:
    runs-on: ubuntu-latest
    needs: [
      detect_release,
      build_client_linux,
      build_client_linux_arm,
      build_client_windows,
      build_client_macos_intel,
      build_client_macos_arm,
    ]
    if: needs.detect_release.outputs.client_release_needed == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: client-*
          merge-multiple: true
          path: artifacts/
      - name: Generate changelog
        id: changelog
        env:
          BEFORE_SHA: ${{ github.event.before }}
          VERSION: ${{ needs.detect_release.outputs.client_version }}
        run: |
          if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            CHANGELOG="Initial release of chatty v$VERSION"
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${BEFORE_SHA}..HEAD -- "crates/chatty_client_gui/" "Cargo.toml" 2>/dev/null || echo "")
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No changes found"
            fi
          fi
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: chatty@v${{ needs.detect_release.outputs.client_version }}
          name: chatty v${{ needs.detect_release.outputs.client_version }}
          body: |
            ## chatty v${{ needs.detect_release.outputs.client_version }}

            ### Changes
            ${{ steps.changelog.outputs.changelog }}
          files: artifacts/**/*
          draft: false
          prerelease: false
